<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-tutorial-basics/create-a-document" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.4.0">
<title data-rh="true">Atomic transfer | Mercury Layer Docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://docs.mercurylayer.com/img/mercury-symbol.png"><meta data-rh="true" name="twitter:image" content="https://docs.mercurylayer.com/img/mercury-symbol.png"><meta data-rh="true" property="og:url" content="https://docs.mercurylayer.com/docs/tutorial-basics/create-a-document"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Atomic transfer | Mercury Layer Docs"><meta data-rh="true" name="description" content="The purpose of the atomic transfer protocol is to enable two (or more) coin transfers to be completed in a way that they all complete or none of them do. This effectively means that the transfer-receiver function and key update is only completed if both receivers have the correct information to proceed. Once each receiver has verified that the transfer message they have received is valid, then the other parties can be allowed to complete transfer-receiver."><meta data-rh="true" property="og:description" content="The purpose of the atomic transfer protocol is to enable two (or more) coin transfers to be completed in a way that they all complete or none of them do. This effectively means that the transfer-receiver function and key update is only completed if both receivers have the correct information to proceed. Once each receiver has verified that the transfer message they have received is valid, then the other parties can be allowed to complete transfer-receiver."><link data-rh="true" rel="icon" href="/img/favicon-32x32.png"><link data-rh="true" rel="canonical" href="https://docs.mercurylayer.com/docs/tutorial-basics/create-a-document"><link data-rh="true" rel="alternate" href="https://docs.mercurylayer.com/docs/tutorial-basics/create-a-document" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.mercurylayer.com/docs/tutorial-basics/create-a-document" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.b272700c.css">
<script src="/assets/js/runtime~main.a486f49c.js" defer="defer"></script>
<script src="/assets/js/main.7a4e98bd.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/mercury-symbol.png" alt="Mercury Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/mercury-symbol.png" alt="Mercury Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Mercury Layer Docs</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro">Docs</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/commerceblock/mercurylayer" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/category/mercury-protocol">Mercury Protocol</a><button aria-label="Collapse sidebar category &#x27;Mercury Protocol&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tutorial-basics/create-a-page">Mercury Layer Protocol</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/tutorial-basics/create-a-document">Atomic transfer</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tutorial-basics/create-a-blog-post">Lightning Latch</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/rust-client">Rust client</a><button aria-label="Expand sidebar category &#x27;Rust client&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/nodejs-client">NodeJS client</a><button aria-label="Expand sidebar category &#x27;NodeJS client&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/kotlin-client">Kotlin client</a><button aria-label="Expand sidebar category &#x27;Kotlin client&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/mercury-protocol"><span itemprop="name">Mercury Protocol</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Atomic transfer</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Atomic transfer</h1>
<p>The purpose of the atomic transfer protocol is to enable two (or more) coin transfers to be completed in a way that they all complete or none of them do. This effectively means that the transfer-receiver function and key update is only completed if both receivers have the correct information to proceed. Once each receiver has verified that the transfer message they have received is valid, then the other parties can be allowed to complete transfer-receiver.</p>
<p>To enable this there needs to be a mechanism to prevent the transfer-receiver being completed before the other parties have verified and confirmed their transfer messages. If all parties verify, then transfer-receiver can proceed, otherwise the key shares are not updated and ownership of the coins remains with the inital owner.</p>
<p>The process is performed by each party in the atomic transfer supplying a <code>batch_id</code> in the transfer-sender message. The use of this (as opposed to leaving this null) is that the statecoin is put into a special <em>locked</em> state for a configured timeout period after the first <code>batch_id</code> is submitted. During this locked status two things are prevented 1) The sender cannot perform another <code>/transfer/sender</code> operation on the same coin (i.e. to send to a different address) and 2) <code>/transfer/receiver</code> cannot be performed until all coins with the same <code>batch_id</code> are <em>unlocked</em> by all the owners unlocking the coins with a new <code>/transfer/unlock</code> function. At the end of the timeout (if all coins with a specified <code>batch_id</code> have not been unlocked), the <code>/transfer/receiver</code> function will still be blocked (i.e. return error) but the original owner can repeat <code>/transfer/sender</code> again with a null <code>batch_id</code> to regain control of the coin.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="protocol">Protocol<a class="hash-link" aria-label="Direct link to Protocol" title="Direct link to Protocol" href="/docs/tutorial-basics/create-a-document#protocol">​</a></h2>
<p>The <code>statechain_transfer</code> DB table can have 3 additional columns: <code>batch_id</code> (string), <code>batch-time</code> (integer) and <code>locked</code> (boolen). By default <code>batch_id</code>, <code>batch-time</code> are null and <code>locked</code> is <code>false</code>. The server is configured with <code>batch-timeout</code> parameter in seconds (in practice this will be some number of minutes). This is set in the server Settings.</p>
<p>The atomic transfer will then proceed as follows:</p>
<ol>
<li>The two or more parties that want to engage in an atomic transfer cooperate and share a <code>batch_id</code> (this is just a random UUID generated by one of the participants and shared with the other). One party can generate it and share with the others.</li>
<li>The parties each generate a <code>ml1</code> address that they want the coin they will recieve paid to and send to the sender.</li>
<li>Each party performs <code>/transfer/sender {statechain_id, batch_id, auth_sig, new_user_auth_key}</code> with the <code>batch_id</code> paying to the receiving party <code>new_user_auth_key</code> and then create and upload the transfer message.</li>
<li>If the <code>batch_id</code> is set in a <code>/transfer/sender</code> call (and not null) the server adds this to the <code>batch_id</code> DB column for the specified <code>statechain_id</code> and updates the <code>locked</code> status to <code>true</code>.</li>
<li>The server then checks all other statecoins to see if the same <code>batch_id</code> is used for any other coin in the table.</li>
<li>If there are no other coins with this <code>batch_id</code>, then it adds the current time (unix epoch time in seconds) to the <code>batch-time</code> column.</li>
<li>If there are any other coin(s) with this same <code>batch_id</code> then the <code>batch-time</code> of those coin(s) is copied to the specified coin <code>batch-time</code> column.</li>
</ol>
<blockquote>
<p>This means that all coins where <code>/transfer/sender</code> have the same <code>batch_id</code> will have the same <code>batch-time</code> set.</p>
</blockquote>
<blockquote>
<p>With this logic, it does not mater which order the coins call <code>/transfer/sender</code>, the first call with a specific <code>batch_id</code> will set the initial <code>batch-time</code> for the atomic transfer.</p>
</blockquote>
<p>When <code>/transfer/sender</code> is called for any coin, if <code>batch-time</code> + <code>batch-timeout</code> (as read from the DB table) is <em>greater</em> than or equal to the current time (i.e. the coin is still within the timeout period) then it will return an error (<code>ERROR: statecoin batch locked</code>).</p>
<p>When <code>/transfer/sender</code> is called for any coin, if <code>batch-time</code> + <code>batch-timeout</code> (as read from the DB table) is <em>less</em> the current time (i.e. the timeout period has ended) the server will check the DB table for any other coins have the same <code>batch_id</code>. For each coin that shares the same<code>batch_id</code>, if all <code>locked</code> values are false, then the transfer-sender returns with an error (<code>ERROR: batch transfer completed</code>) (in this case all participants have verified the transfer message and the atomic transfer must complete - all parties must perform transfer-receiver).
If all <code>locked</code> values are NOT false <code>/transfer/sender</code> can be called again with a null or different <code>batch_id</code>. If called with null <code>batch_id</code> then <code>batch-time</code> is set to null and <code>locked</code> to false.</p>
<ol start="8">
<li>
<p>Each participant in the atomic transfer then polls <code>/transfer/get_msg_addr</code> with their receive address within the timeout period. If they receive a transfer message, they fully verify as usual. If the verification passes, then the participant calls a function <code>/transfer/unlock {statechain_id, auth_sig}</code> which changes the <code>locked</code> status of the coin (<code>statechain_id</code>) in the DB table to <code>false</code>.
If the <code>batch-time</code> + <code>batch-timeout</code> is less than the current time, then the <code>/transfer/unlock</code> function should not unlock and instead return an error.</p>
</li>
<li>
<p>Each participant then calls <code>transfer-reciever</code>. If <code>/transfer/receiver</code> is called on any coin and <code>batch_id</code> and <code>batch-time</code> are set (not null) and <code>locked</code> is false, then the server checks if any other coins in the DB table have the same <code>batch_id</code>. For alls coin that share the same <code>batch_id</code>, if all <code>locked</code> are false, then the function proceeds with the key update, otherwise it returns with an error (<code>ERROR: coin in locked state</code>).
If <code>/transfer/receiver</code> is called on any coin and <code>batch_id</code> and <code>batch-time</code> are set (not null) and <code>locked</code> is true, then this function should return an error.</p>
</li>
</ol>
<p>The outcomes of this protocol:</p>
<p>Any coins where <code>/transfer/sender</code> is called with a specific <code>batch-id</code> within the <code>batch-time</code> of the first one to call, will be added to the batch transfer.</p>
<p>Then, if all parties coins progress to call <code>/transfer/unlock</code> within the <code>batch-time</code> then <code>/transfer/receiver</code> can be performed for all coins by each party.</p>
<p>If any single participant doesn&#x27;t call <code>/transfer/unlock</code> within the <code>batch-time</code> then no-one can call <code>/transfer/receiver</code> but after the <code>batch-time</code> expiry each owner can call <code>/transfer/sender</code> again to recover the coin (i.e. send to to their own address with null <code>batch_id</code> and then calling transfer-receiver).</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/tutorial-basics/create-a-page"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Mercury Layer Protocol</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/tutorial-basics/create-a-blog-post"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Lightning Latch</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a class="table-of-contents__link toc-highlight" href="/docs/tutorial-basics/create-a-document#protocol">Protocol</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Documentation</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://t.me/mercury_layer" target="_blank" rel="noopener noreferrer" class="footer__link-item">Telegram<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/mercurylayer" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 Commerceblock.</div></div></div></footer></div>
</body>
</html>